services:
  beelzebub:
    build: .
    container_name: beelzebub
    restart: always
    ports:
      - "22:22"
      - "23:23"
      - "2222:2222"
      - "8080:8080"
      - "8081:8081"
      - "80:80"
      - "3306:3306"
      - "502:502"   # Modbus TCP
      - "102:102"   # Siemens S7Comm
      - "2404:2404" # IEC 60870-5-104
      - "2112:2112" # Prometheus Open Metrics
    environment:
      RABBITMQ_URI: ${RABBITMQ_URI}
      OPEN_AI_SECRET_KEY: ${OPEN_AI_SECRET_KEY}
    volumes:
      - "./configurations:/configurations"
    depends_on:
      - ollama
    logging:
      driver: json-file
      options:
        tag: "beelzebub"

  prometheus:
    image: prom/prometheus:v3.2.1
    container_name: prometheus
    restart: always
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    depends_on:
      - beelzebub

  loki:
    image: grafana/loki:3.4.2
    container_name: loki
    restart: always
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki-data:/loki

  promtail:
    image: grafana/promtail:3.4.2
    container_name: promtail
    restart: always
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./monitoring/promtail-config.yaml:/etc/promtail/config.yaml:ro
    command: -config.file=/etc/promtail/config.yaml
    depends_on:
      - loki

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    restart: always
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=beelzebub
      - DOCKER_INFLUXDB_INIT_ORG=ot-plant
      - DOCKER_INFLUXDB_INIT_BUCKET=process-data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=beelzebub-historian-token
    volumes:
      - influxdb-data:/var/lib/influxdb2

  telegraf:
    image: telegraf:1.33
    container_name: telegraf
    restart: always
    volumes:
      - ./monitoring/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    depends_on:
      - beelzebub
      - influxdb

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama

  ollama-init:
    image: curlimages/curl:8.12.1
    container_name: ollama-init
    restart: "no"
    depends_on:
      - ollama
    command: >
      sh -c "
        sleep 5;
        echo 'Pulling llama3.2:1b model...';
        curl -s -X POST http://ollama:11434/api/pull -d '{\"name\":\"llama3.2:1b\"}' | tail -1;
        echo 'Model ready.'
      "

  geoip-init:
    image: curlimages/curl:8.12.1
    container_name: geoip-init
    restart: "no"
    user: root
    volumes:
      - geoip-data:/geoip
    command: >
      sh -c "
        FILE=/geoip/dbip-country-lite.mmdb;
        if [ ! -f $$FILE ]; then
          echo 'Downloading DB-IP GeoLite database...';
          YEAR=$$(date +%Y);
          MONTH=$$(date +%m);
          curl -fsSL https://download.db-ip.com/free/dbip-country-lite-$${YEAR}-$${MONTH}.mmdb.gz | gunzip > $$FILE && echo 'GeoIP database ready.' || echo 'Download failed, maps will be empty.';
        else
          echo 'GeoIP database already present.';
        fi
      "

  grafana:
    image: grafana/grafana:11.5.2
    container_name: grafana
    restart: always
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=beelzebub
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_ANALYTICS_REPORTING_ENABLED=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - geoip-data:/var/lib/grafana/geoip:ro
    depends_on:
      - loki
      - geoip-init

volumes:
  loki-data:
  grafana-data:
  prometheus-data:
  geoip-data:
  influxdb-data:
  ollama-data:
